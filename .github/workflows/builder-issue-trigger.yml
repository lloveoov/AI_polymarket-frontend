name: Builder Issue Trigger

on:
  issues:
    types: [assigned, reopened, labeled]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check assignee
        id: check_assignee
        run: |
          if [ "${{ github.event_name }}" = "assigned" ]; then
            ASSIGNEE="${{ github.event.issue.assignee.login }}"
            if [ "$ASSIGNEE" = "orion-code1" ]; then
              echo "should_notify=true" >> $GITHUB_OUTPUT
            else
              echo "should_notify=false" >> $GITHUB_OUTPUT
            fi
          else
            ASSIGNEES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}" | \
              jq -r '.assignees[]?.login')
            if echo "$ASSIGNEES" | grep -q "orion-code1"; then
              echo "should_notify=true" >> $GITHUB_OUTPUT
            else
              echo "should_notify=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Send Telegram Notification
        if: steps.check_assignee.outputs.should_notify == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAMBOTTOKEN || secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAMCHATID || secrets.TELEGRAM_CHAT_ID }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ACTION_TYPE: ${{ github.event.action }}
        run: |
          MESSAGE="@Orion1CodeBot START: Issue #$ISSUE_NUMBER $ISSUE_TITLE\n$ISSUE_URL\n请在 issue 下回复 Plan+ETA，然后开 PR request review @orion-qa。"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}"
